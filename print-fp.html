<!DOCTYPE html>
<HTML>

<HEAD>

  <title>Alexandr Poltavsky, software developer</title>

  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta http-equiv="Cache-Control" content="no-store" />

  <link rel="stylesheet" type="text/css" href="css/common.css" />

</HEAD>

<BODY> 

<div id="wrap">

  <div id="header">
    <a href="/" title="Back home">
    <img width="160" src="images/alexandr-poltavsky-avatar.jpeg" title="Energia-Buran Military Space System" align="left"/>
    </a>
    <strong>
            Personal blog of Alexandr Poltavsky. <br/> 
            Software developer. <em>alexpolt&#64;yandex.ru</em><br/>
            <ul id="menu">
              <li><a href="/">Contents</a></li>
              <li><a href="https://github.com/alexpolt/">Github</a></li>
            </ul>
    </strong>
  </div>

  <div id="content" style="clear: left">

<h1>A quick and easy way to print a float in base-10.</h1>

<p>The implementation of <em>printf</em> for the "<em>%f</em>" format specifier is quite involved. 
  I invite you to take a look <a href="https://gcc.gnu.org/bugzilla/attachment.cgi?id=24137"><em>printf_fp.c</em></a>. That's hard.</p>

<p>But there is a hack, that you could use in cases where you don't need an exact number.</p>

<p>The format of a 32-bit floating point in modern systems is 
  <img src="images/fp-format.png" alt="float format" title="Floating point number format" /> where b = 2 ( &copy;Wikipedia ).</p>

<p>You could transform the base-2 exponent to base-10, take the integer part, and multiply the rest of the number with 
  fractional part. This way you essentially get a base-10 number. I provide a draft implementation that you could use
  and improve.</p>

<pre><code>#include &lt;cstdio&gt;
#include &lt;cmath&gt;

int main() {

    union {
        float d;
        int u;
    };

    d = -0.00594;

    printf("%.10f\n", d); //original numer

    bool minus = u &gt;&gt; 31; //store sign
    u = u &amp; ~(1 &lt;&lt; 31); //clear sign
    double exp = (u &gt;&gt; 23) - 127; //extract exponent
    double exp10 = exp / log2( 10.0 ); //compute base-10

    //adjust the number
    u = (u &amp; ~(0xFF &lt;&lt; 23)) | (127 &lt;&lt; 23);
    double d2 = double(d) * pow( 10.0, exp10 - int(exp10) ); 
    if( d2 &gt;= 10.0 ) { d2 = d2 / 10.0; exp10+=1.0; }
    if( d2 &lt; 1.0 ) { d2 = d2 * 10.0; exp10-=1.0; }

    //print sign
    if( minus ) printf("-");

    //print integer part
    int i = int( d2 );
    printf("%.1d.", i);
    d2 = d2 - i;

    //print the rest
    int digits = 10; 

    while( digits-- ) { 
        d2 = d2 * 10.0;
        int i = int( d2 );
        printf("%.1d", i);
        d2 = d2 - i;
    }

    //print exponent part
    printf("e%d", int(exp10));

}

Output:

-0.0059400001
-5.9400000609e-3
</code></pre>

<p>It's just a sketch, you can improve the code. Also I haven't done error analysis. 
  All calculations are done in double, so I expect this to work at least for floats.</p>

<p>I'd like to thank <strong>Bruce Dawson</strong> for his outstanding series on 
  <a href="https://randomascii.wordpress.com/category/floating-point/">floating points</a>.</p>

<p><strong>Alexandr Poltavsky</strong> <br />
  <em>2016-03-18T21:19+0300</em></p>

  </div> <!-- end content -->
</div> <!-- end wrap -->

</BODY>

